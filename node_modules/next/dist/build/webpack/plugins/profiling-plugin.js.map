{"version":3,"sources":["../../../../build/webpack/plugins/profiling-plugin.ts"],"names":["pluginName","spans","WeakMap","getNormalModuleLoaderHook","compilation","isWebpack5","webpack","NormalModule","getCompilationHooks","loader","hooks","normalModuleLoader","tracingIsEnabled","tracerProvider","trace","getTracerProvider","ProxyTracerProvider","proxyDelegate","getDelegate","NoopTracerProvider","ProfilingPlugin","compiler","apply","traceTopLevelHooks","traceCompilationHooks","traceHookPair","spanName","startHook","stopHook","attrs","onSetSpan","span","tap","traceLoopedHook","compile","done","attributes","name","set","environment","afterEnvironment","invalid","buildModule","module","compilerSpan","get","tracer","withSpan","startSpan","setAttribute","userRequest","loaderContext","parentSpan","currentTraceSpan","succeedModule","end","beforeCompile","afterCompile","beforeChunks","afterChunks","optimize","reviveModules","optimizeModules","afterOptimizeModules","optimizeChunks","afterOptimizeChunks","optimizeTree","afterOptimizeTree","beforeHash","afterHash"],"mappings":"kFAAA,oCACA,2DACA,uCAOA,KAAMA,CAAAA,UAAU,CAAG,iBAAnB,CACO,KAAMC,CAAAA,KAAK,CAAG,GAAIC,CAAAA,OAAJ,EAAd,C,oBAEP,QAASC,CAAAA,yBAAT,CAAmCC,WAAnC,CAAqD,CACnD,GAAIC,mBAAJ,CAAgB,CACd;AACA,MAAOC,kBAAQC,YAAR,CAAqBC,mBAArB,CAAyCJ,WAAzC,EAAsDK,MAA7D,CACD,CAED,MAAOL,CAAAA,WAAW,CAACM,KAAZ,CAAkBC,kBAAzB,CACD,CAED,QAASC,CAAAA,gBAAT,EAA4B,CAC1B,KAAMC,CAAAA,cAAmB,CAAGC,WAAMC,iBAAN,EAA5B,CACA,GAAIF,cAAc,WAAYG,yBAA9B,CAAmD,CACjD,KAAMC,CAAAA,aAAkB,CAAGJ,cAAc,CAACK,WAAf,EAA3B,CACA,MAAO,EAAED,aAAa,WAAYE,wBAA3B,CAAP,CACD,CACD,MAAO,MAAP,CACD,CAEM,KAAMC,CAAAA,eAAgB,oBAC3BC,QAD2B,SAG3BC,KAAK,CAACD,QAAD,CAAgB,CACnB;AACA,GAAI,CAACT,gBAAgB,EAArB,CAAyB,CACvB,OACD,CACD,KAAKW,kBAAL,CAAwBF,QAAxB,EACA,KAAKG,qBAAL,CAA2BH,QAA3B,EACA,KAAKA,QAAL,CAAgBA,QAAhB,CACD,CAEDI,aAAa,CACXC,QADW,CAEXC,SAFW,CAGXC,QAHW,CAIXC,KAJW,CAKXC,SALW,CAMX,CACA,GAAIC,CAAAA,IAAJ,CACAJ,SAAS,CAACK,GAAV,CAAchC,UAAd,CAA0B,IAAM,CAC9B+B,IAAI,CAAG,sBAAU,KAAKV,QAAf,CAAyBK,QAAzB,CAAmCG,KAAnC,CAAP,CACAC,SAAS,MAAT,QAAAA,SAAS,CAAGC,IAAH,CAAT,CACD,CAHD,EAIAH,QAAQ,CAACI,GAAT,CAAahC,UAAb,CAAyB,IAAM,CAC7B,qBAAS,KAAKqB,QAAd,CAAwBU,IAAxB,EACD,CAFD,EAGD,CAEDE,eAAe,CAACP,QAAD,CAAmBC,SAAnB,CAAmCC,QAAnC,CAAkD,CAC/D,GAAIG,CAAAA,IAAJ,CACAJ,SAAS,CAACK,GAAV,CAAchC,UAAd,CAA0B,IAAM,CAC9B,GAAI,CAAC+B,IAAL,CAAW,CACTA,IAAI,CAAG,sBAAU,KAAKV,QAAf,CAAyBK,QAAzB,CAAP,CACD,CACF,CAJD,EAKAE,QAAQ,CAACI,GAAT,CAAahC,UAAb,CAAyB,IAAM,CAC7B,qBAAS,KAAKqB,QAAd,CAAwBU,IAAxB,EACD,CAFD,EAGD,CAEDR,kBAAkB,CAACF,QAAD,CAAgB,CAChC,KAAKI,aAAL,CACE,iBADF,CAEEJ,QAAQ,CAACX,KAAT,CAAewB,OAFjB,CAGEb,QAAQ,CAACX,KAAT,CAAeyB,IAHjB,CAIE,IAAM,CACJ,MAAO,CAAEC,UAAU,CAAE,CAAEC,IAAI,CAAEhB,QAAQ,CAACgB,IAAjB,CAAd,CAAP,CACD,CANH,CAOGN,IAAD,EAAU9B,KAAK,CAACqC,GAAN,CAAUjB,QAAV,CAAoBU,IAApB,CAPZ,EASA,KAAKN,aAAL,CACE,qBADF,CAEEJ,QAAQ,CAACX,KAAT,CAAe6B,WAFjB,CAGElB,QAAQ,CAACX,KAAT,CAAe8B,gBAHjB,EAKA,KAAKf,aAAL,CACE,qBADF,CAEEJ,QAAQ,CAACX,KAAT,CAAe+B,OAFjB,CAGEpB,QAAQ,CAACX,KAAT,CAAeyB,IAHjB,EAKD,CAEDX,qBAAqB,CAACH,QAAD,CAAgB,CACnCA,QAAQ,CAACX,KAAT,CAAeN,WAAf,CAA2B4B,GAA3B,CAA+BhC,UAA/B,CAA4CI,WAAD,EAAsB,CAC/DA,WAAW,CAACM,KAAZ,CAAkBgC,WAAlB,CAA8BV,GAA9B,CAAkChC,UAAlC,CAA+C2C,MAAD,EAAiB,CAC7D,KAAMC,CAAAA,YAAY,CAAG3C,KAAK,CAAC4C,GAAN,CAAUxB,QAAV,CAArB,CACA,GAAI,CAACuB,YAAL,CAAmB,CACjB,OACD,CACDE,eAAOC,QAAP,CAAgBH,YAAhB,CAA8B,IAAM,CAClC,KAAMb,CAAAA,IAAI,CAAGe,eAAOE,SAAP,CAAiB,cAAjB,CAAb,CACAjB,IAAI,CAACkB,YAAL,CAAkB,MAAlB,CAA0BN,MAAM,CAACO,WAAjC,EACAjD,KAAK,CAACqC,GAAN,CAAUK,MAAV,CAAkBZ,IAAlB,EACD,CAJD,EAKD,CAVD,EAYA5B,yBAAyB,CAACC,WAAD,CAAzB,CAAuC4B,GAAvC,CACEhC,UADF,CAEE,CAACmD,aAAD,CAAqBR,MAArB,GAAqC,CACnC,KAAMS,CAAAA,UAAU,CAAGnD,KAAK,CAAC4C,GAAN,CAAUF,MAAV,CAAnB,CACAQ,aAAa,CAACE,gBAAd,CAAiCD,UAAjC,CACD,CALH,EAQAhD,WAAW,CAACM,KAAZ,CAAkB4C,aAAlB,CAAgCtB,GAAhC,CAAoChC,UAApC,CAAiD2C,MAAD,EAAiB,CAC/D1C,KAAK,CAAC4C,GAAN,CAAUF,MAAV,EAAkBY,GAAlB,GACD,CAFD,EAIA,GAAIlD,mBAAJ,CAAgB,CACd,KAAKoB,aAAL,CACE,qBADF,CAEErB,WAAW,CAACM,KAAZ,CAAkB8C,aAFpB,CAGEpD,WAAW,CAACM,KAAZ,CAAkB+C,YAHpB,EAKD,CAED,KAAKhC,aAAL,CACE,iCADF,CAEErB,WAAW,CAACM,KAAZ,CAAkBgD,YAFpB,CAGEtD,WAAW,CAACM,KAAZ,CAAkBiD,WAHpB,EAKA,KAAKlC,aAAL,CACE,8BADF,CAEErB,WAAW,CAACM,KAAZ,CAAkBkD,QAFpB,CAGExD,WAAW,CAACM,KAAZ,CAAkBmD,aAHpB,EAKA,KAAK5B,eAAL,CACE,sCADF,CAEE7B,WAAW,CAACM,KAAZ,CAAkBoD,eAFpB,CAGE1D,WAAW,CAACM,KAAZ,CAAkBqD,oBAHpB,EAKA,KAAK9B,eAAL,CACE,qCADF,CAEE7B,WAAW,CAACM,KAAZ,CAAkBsD,cAFpB,CAGE5D,WAAW,CAACM,KAAZ,CAAkBuD,mBAHpB,EAKA,KAAKxC,aAAL,CACE,mCADF,CAEErB,WAAW,CAACM,KAAZ,CAAkBwD,YAFpB,CAGE9D,WAAW,CAACM,KAAZ,CAAkByD,iBAHpB,EAKA,KAAK1C,aAAL,CACE,0BADF,CAEErB,WAAW,CAACM,KAAZ,CAAkB0D,UAFpB,CAGEhE,WAAW,CAACM,KAAZ,CAAkB2D,SAHpB,EAKD,CA/DD,EAgED,CAjI0B,C","sourcesContent":["import { tracer, stackPush, stackPop } from '../../tracer'\nimport { webpack, isWebpack5 } from 'next/dist/compiled/webpack/webpack'\nimport {\n  Span,\n  trace,\n  ProxyTracerProvider,\n  NoopTracerProvider,\n} from '@opentelemetry/api'\n\nconst pluginName = 'ProfilingPlugin'\nexport const spans = new WeakMap()\n\nfunction getNormalModuleLoaderHook(compilation: any) {\n  if (isWebpack5) {\n    // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n    return webpack.NormalModule.getCompilationHooks(compilation).loader\n  }\n\n  return compilation.hooks.normalModuleLoader\n}\n\nfunction tracingIsEnabled() {\n  const tracerProvider: any = trace.getTracerProvider()\n  if (tracerProvider instanceof ProxyTracerProvider) {\n    const proxyDelegate: any = tracerProvider.getDelegate()\n    return !(proxyDelegate instanceof NoopTracerProvider)\n  }\n  return false\n}\n\nexport class ProfilingPlugin {\n  compiler: any\n\n  apply(compiler: any) {\n    // Only enable plugin when instrumentation is loaded\n    if (!tracingIsEnabled()) {\n      return\n    }\n    this.traceTopLevelHooks(compiler)\n    this.traceCompilationHooks(compiler)\n    this.compiler = compiler\n  }\n\n  traceHookPair(\n    spanName: string,\n    startHook: any,\n    stopHook: any,\n    attrs?: any,\n    onSetSpan?: (span: Span | undefined) => void\n  ) {\n    let span: Span | undefined\n    startHook.tap(pluginName, () => {\n      span = stackPush(this.compiler, spanName, attrs)\n      onSetSpan?.(span)\n    })\n    stopHook.tap(pluginName, () => {\n      stackPop(this.compiler, span)\n    })\n  }\n\n  traceLoopedHook(spanName: string, startHook: any, stopHook: any) {\n    let span: Span | undefined\n    startHook.tap(pluginName, () => {\n      if (!span) {\n        span = stackPush(this.compiler, spanName)\n      }\n    })\n    stopHook.tap(pluginName, () => {\n      stackPop(this.compiler, span)\n    })\n  }\n\n  traceTopLevelHooks(compiler: any) {\n    this.traceHookPair(\n      'webpack-compile',\n      compiler.hooks.compile,\n      compiler.hooks.done,\n      () => {\n        return { attributes: { name: compiler.name } }\n      },\n      (span) => spans.set(compiler, span)\n    )\n    this.traceHookPair(\n      'webpack-prepare-env',\n      compiler.hooks.environment,\n      compiler.hooks.afterEnvironment\n    )\n    this.traceHookPair(\n      'webpack-invalidated',\n      compiler.hooks.invalid,\n      compiler.hooks.done\n    )\n  }\n\n  traceCompilationHooks(compiler: any) {\n    compiler.hooks.compilation.tap(pluginName, (compilation: any) => {\n      compilation.hooks.buildModule.tap(pluginName, (module: any) => {\n        const compilerSpan = spans.get(compiler)\n        if (!compilerSpan) {\n          return\n        }\n        tracer.withSpan(compilerSpan, () => {\n          const span = tracer.startSpan('build-module')\n          span.setAttribute('name', module.userRequest)\n          spans.set(module, span)\n        })\n      })\n\n      getNormalModuleLoaderHook(compilation).tap(\n        pluginName,\n        (loaderContext: any, module: any) => {\n          const parentSpan = spans.get(module)\n          loaderContext.currentTraceSpan = parentSpan\n        }\n      )\n\n      compilation.hooks.succeedModule.tap(pluginName, (module: any) => {\n        spans.get(module).end()\n      })\n\n      if (isWebpack5) {\n        this.traceHookPair(\n          'webpack-compilation',\n          compilation.hooks.beforeCompile,\n          compilation.hooks.afterCompile\n        )\n      }\n\n      this.traceHookPair(\n        'webpack-compilation-chunk-graph',\n        compilation.hooks.beforeChunks,\n        compilation.hooks.afterChunks\n      )\n      this.traceHookPair(\n        'webpack-compilation-optimize',\n        compilation.hooks.optimize,\n        compilation.hooks.reviveModules\n      )\n      this.traceLoopedHook(\n        'webpack-compilation-optimize-modules',\n        compilation.hooks.optimizeModules,\n        compilation.hooks.afterOptimizeModules\n      )\n      this.traceLoopedHook(\n        'webpack-compilation-optimize-chunks',\n        compilation.hooks.optimizeChunks,\n        compilation.hooks.afterOptimizeChunks\n      )\n      this.traceHookPair(\n        'webpack-compilation-optimize-tree',\n        compilation.hooks.optimizeTree,\n        compilation.hooks.afterOptimizeTree\n      )\n      this.traceHookPair(\n        'webpack-compilation-hash',\n        compilation.hooks.beforeHash,\n        compilation.hooks.afterHash\n      )\n    })\n  }\n}\n"]}